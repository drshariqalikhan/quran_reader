<!DOCTYPE html>
<html lang="en" class="has-background-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Quran Reader</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- CUSTOM ICON -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9ImJsYWNrIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iJ1NlZ29lIFVJJywgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iNjAyIj48dHNwYW4geD0iNTAlIiBkeT0iMCI+RWFzeTwvdHNwYW4+PHRzcGFuIHg0PSI1MCUiIGR5PSI4MCI+UXVyYW48L3RzcGFuPjx0c3BhbiB4PSI1MCUiIGR5PSI4MCI+UmVhZGVyPC90c3Bhbj48L3RleHQ+PC9zdmc+">
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Easy Quran Reader","short_name":"Quran","description":"Minimalist Quran Reader","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9ImJsYWNrIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iJ1NlZ29lIFVJJywgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iNjAiPjx0c3BhbiB4PSI1MCUiIGR5PSIwIj5FYXN5PC90c3Bhbj48dHNwYW4geD0iNTAlIiBkeT0iODAiPlF1cmFuPC90c3Bhbj48dHNwYW4geD0iNTAlIiBkeT0iODAiPlJlYWRlcjwvdHNwYW4+PC90ZXh0Pjwvc3ZnPg==","sizes":"512x512","type":"image/svg+xml"}]}'>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --text-arabic: #ffffff;
            --text-trans: #4aedc4;
            --text-en: #b0b0b0;
            --accent: #ffd700;
            --audio-playing: #4aedc4;
        }

        body, html {
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .reader-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem 2rem;
            text-align: center;
            touch-action: none;
            user-select: none;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: clamp(1.8rem, 8vw, 3.2rem);
            direction: rtl;
            color: var(--text-arabic);
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .transliteration {
            font-size: clamp(0.9rem, 4vw, 1.2rem);
            color: var(--text-trans);
            font-style: italic;
            margin-bottom: 0.8rem;
        }

        .translation {
            font-size: clamp(0.9rem, 4vw, 1.1rem);
            color: var(--text-en);
            max-width: 90%;
            line-height: 1.4;
        }

        .top-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: env(safe-area-inset-top, 15px) 15px 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(15px);
            z-index: 10;
        }

        /* Styling the selectors for dark mode */
        .navigation-selectors {
            display: flex;
            gap: 8px;
        }

        .select select {
            background-color: #1a1a1a !important;
            color: white !important;
            border-color: #333 !important;
            font-size: 0.8rem !important;
            height: 2.2rem !important;
        }
        .select:not(.is-multiple):not(.is-loading)::after {
            border-color: var(--text-trans) !important;
        }

        .top-bar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
        }

        #bookmark-btn.is-active { color: var(--accent); }
        #audio-btn.is-playing { color: var(--audio-playing); transform: scale(1.1); }

        #loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body>

    <div id="loader">
        <button class="button is-loading is-black is-large"></button>
    </div>

    <div class="top-bar">
        <div class="navigation-selectors">
            <div class="select is-small">
                <select id="surah-select"></select>
            </div>
            <div class="select is-small">
                <select id="ayah-select"></select>
            </div>
        </div>
        
        <div class="top-bar-actions">
            <button id="audio-btn" class="action-btn" title="Hear Recitation">
                <i class="fas fa-volume-up"></i>
            </button>
            <button id="bookmark-btn" class="action-btn" title="Toggle Bookmark">
                <i class="fas fa-bookmark"></i>
            </button>
        </div>
    </div>

    <main class="reader-container" id="app">
        <div class="arabic-text" id="arabic"></div>
        <div class="transliteration" id="transliteration"></div>
        <div class="translation" id="translation"></div>
    </main>

    <script>
        /** SERVICE WORKER **/
        const swCode = `
            const CACHE_NAME = 'quran-reader-v4';
            self.addEventListener('install', (e) => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll([
                    'https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css',
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
                ])));
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
            });
        `;

        if ('serviceWorker' in navigator) {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(console.error);
        }

        /** APP LOGIC **/
        const API_EN = "https://cdn.jsdelivr.net/npm/quran-json@3.1.2/dist/quran_en.json";
        const API_TRANS = "https://cdn.jsdelivr.net/npm/quran-json@3.1.2/dist/quran_transliteration.json";
        const API_AR = "https://cdn.jsdelivr.net/npm/quran-json@3.1.2/dist/quran.json";

        let quranData = { ar: null, en: null, tr: null };
        let curS = 0; 
        let curA = 0; 
        let touchStartX = 0;
        let bookmarks = [];
        let audioPlayer = new Audio();

        const surahSelect = document.getElementById('surah-select');
        const ayahSelect = document.getElementById('ayah-select');
        const btnBookmark = document.getElementById('bookmark-btn');
        const btnAudio = document.getElementById('audio-btn');

        async function init() {
            try {
                const [rAr, rEn, rTr] = await Promise.all([
                    fetch(API_AR).then(r => r.json()),
                    fetch(API_EN).then(r => r.json()),
                    fetch(API_TRANS).then(r => r.json())
                ]);

                quranData.ar = rAr;
                quranData.en = rEn;
                quranData.tr = rTr;

                // Populate Surah Dropdown
                quranData.en.forEach((s, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = `${idx + 1}. ${s.transliteration}`;
                    surahSelect.appendChild(opt);
                });

                const lastPos = localStorage.getItem('quran_last_pos');
                if (lastPos) {
                    const pos = JSON.parse(lastPos);
                    curS = pos.s; curA = pos.a;
                }

                const savedBookmarks = localStorage.getItem('quran_bookmarks');
                if (savedBookmarks) bookmarks = JSON.parse(savedBookmarks);

                document.getElementById('loader').style.display = 'none';
                render();
            } catch (err) {
                console.error(err);
                alert("Connection required for first load.");
            }
        }

        function updateAyahDropdown() {
            ayahSelect.innerHTML = '';
            const totalAyahs = quranData.ar[curS].verses.length;
            for (let i = 0; i < totalAyahs; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `Ayah ${i + 1}`;
                ayahSelect.appendChild(opt);
            }
            ayahSelect.value = curA;
        }

        function getGlobalAyahIndex(surahIdx, ayahIdx) {
            let total = 0;
            for (let i = 0; i < surahIdx; i++) {
                total += quranData.ar[i].verses.length;
            }
            return total + ayahIdx + 1;
        }

        function playRecitation() {
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                btnAudio.classList.remove('is-playing');
                return;
            }
            const globalIndex = getGlobalAyahIndex(curS, curA);
            const audioUrl = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${globalIndex}.mp3`;
            btnAudio.classList.add('is-loading');
            audioPlayer.src = audioUrl;
            audioPlayer.play().then(() => {
                btnAudio.classList.remove('is-loading');
                btnAudio.classList.add('is-playing');
            }).catch(e => {
                btnAudio.classList.remove('is-loading');
            });
        }

        audioPlayer.onended = () => btnAudio.classList.remove('is-playing');

        function render() {
            audioPlayer.pause();
            btnAudio.classList.remove('is-playing', 'is-loading');

            const sAr = quranData.ar[curS];
            const sEn = quranData.en[curS];
            const sTr = quranData.tr[curS];

            document.getElementById('arabic').innerText = sAr.verses[curA].text;
            document.getElementById('translation').innerText = sEn.verses[curA].translation;
            document.getElementById('transliteration').innerText = sTr.verses[curA].transliteration;
            
            // Sync dropdowns
            if(surahSelect.value != curS) {
                surahSelect.value = curS;
            }
            updateAyahDropdown();

            updateBookmarkIcon();
            localStorage.setItem('quran_last_pos', JSON.stringify({s: curS, a: curA}));
        }

        function updateBookmarkIcon() {
            const currentKey = `${curS}:${curA}`;
            btnBookmark.classList.toggle('is-active', bookmarks.includes(currentKey));
        }

        function toggleBookmark() {
            const currentKey = `${curS}:${curA}`;
            const index = bookmarks.indexOf(currentKey);
            if (index > -1) bookmarks.splice(index, 1);
            else bookmarks.push(currentKey);
            localStorage.setItem('quran_bookmarks', JSON.stringify(bookmarks));
            updateBookmarkIcon();
        }

        function navigate(dir) {
            if (dir === 'next') {
                if (curA < quranData.ar[curS].verses.length - 1) { curA++; } 
                else if (curS < 113) { curS++; curA = 0; }
            } else {
                if (curA > 0) { curA--; } 
                else if (curS > 0) { curS--; curA = quranData.ar[curS].verses.length - 1; }
            }
            render();
        }

        // Event Listeners for Selectors
        surahSelect.addEventListener('change', (e) => {
            curS = parseInt(e.target.value);
            curA = 0;
            render();
        });

        ayahSelect.addEventListener('change', (e) => {
            curA = parseInt(e.target.value);
            render();
        });

        btnBookmark.addEventListener('click', toggleBookmark);
        btnAudio.addEventListener('click', playRecitation);

        const app = document.getElementById('app');
        app.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        app.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            if (diff > 50) navigate('next'); 
            if (diff < -50) navigate('prev');
        }, {passive: true});

        window.addEventListener('keydown', (e) => {
            if (e.key === "ArrowRight") navigate('next');
            if (e.key === "ArrowLeft") navigate('prev');
            if (e.key === " ") { e.preventDefault(); playRecitation(); }
        });

        init();
    </script>
</body>
</html>